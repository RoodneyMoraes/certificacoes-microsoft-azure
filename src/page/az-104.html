<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado da Microsoft Azure AZ-104</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/custom-page.css" rel="stylesheet">
</head>

<body>
    <header>
        <div class="container">
            <h1 id="tituloPagina"></h1>
            <h6 id="descricaoProgresso"></h6>
        </div>
    </header>

    <div class="container topicos mt-6">
        <div id="topicos" class="list-group mt-3"></div>
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        async function carregarDados() {
            try {
                const response = await fetch('../data/az-104.json');
                const data = await response.json();
                console.log('Dados carregados com sucesso', data);
                return data;
            } catch (error) {
                console.error('Erro ao carregar os dados', error);
            }
        }

        async function iniciar() {
            const data = await carregarDados();
            if (!data) return;

            let topicos = Object.keys(data).filter(key => key !== 'title').map(key => ({ Titulo: key, Itens: data[key] }));
            let paginaAtual = 0;

            function contarTotalDeLinks() {
                let totalLinks = 0;
                topicos.forEach(topico => {
                    totalLinks += topico.Itens.length;
                });
                return totalLinks;
            }

            function marcarComoVisitado(link) {
                const visitados = JSON.parse(localStorage.getItem('simulado-az-104') || '[]');
                if (!visitados.includes(link)) {
                    visitados.push(link);
                    localStorage.setItem('simulado-az-104', JSON.stringify(visitados));
                }
                atualizarBarraDeProgresso();
            }

            function foiVisitado(link) {
                const visitados = JSON.parse(localStorage.getItem('simulado-az-104') || '[]');
                return visitados.includes(link);
            }

            function exibirTopicos() {
                if (topicos.length === 0) return;
                const topicoAtual = topicos[paginaAtual];
                const container = document.getElementById("topicos");
                const tituloPagina = document.getElementById("tituloPagina");
                tituloPagina.textContent = topicoAtual.Titulo;
                container.innerHTML = "";

                topicoAtual.Itens.forEach(item => {
                    const elemento = document.createElement("a");
                    elemento.href = item.link;
                    elemento.classList.add("list-group-item", "list-group-item-action");
                    elemento.target = "_blank";
                    elemento.textContent = item.title;
                    if (foiVisitado(item.link)) {
                        elemento.style.backgroundColor = "lightgreen";
                    }
                    elemento.addEventListener('click', (e) => {
                        e.target.style.backgroundColor = "lightgreen";
                        marcarComoVisitado(item.link);
                    });
                    container.appendChild(elemento);
                });
                atualizarInfoPagina();
                atualizarBotoes();
                atualizarBarraDeProgresso();
            }

            function proximaPagina() {
                if (paginaAtual < topicos.length - 1) {
                    paginaAtual++;
                    exibirTopicos();
                }
            }

            function paginaAnterior() {
                if (paginaAtual > 0) {
                    paginaAtual--;
                    exibirTopicos();
                }
            }

            function atualizarInfoPagina() {
                const infoPagina = document.getElementById("infoPagina");
                infoPagina.textContent = `Página ${paginaAtual + 1} de ${topicos.length}`;
            }

            function atualizarBotoes() {
                const btnAnterior = document.getElementById("btnAnterior");
                const btnProxima = document.getElementById("btnProxima");
                btnAnterior.disabled = paginaAtual === 0;
                btnProxima.disabled = paginaAtual >= topicos.length - 1;
            }

            function atualizarBarraDeProgresso() {
                const topicoAtual = topicos[paginaAtual];
                const visitados = JSON.parse(localStorage.getItem('simulado-az-104') || '[]');
                const totalItens = topicoAtual.Itens.length;
                const itensVisitados = topicoAtual.Itens.filter(item => visitados.includes(item.link)).length;
                const percentualVisitado = (itensVisitados / totalItens) * 100;
                const textoDescricao = `Você acessou ${Math.round(percentualVisitado)}% porcento (${itensVisitados} de ${totalItens}) dos links abaixo - Total de Perguntas: (${contarTotalDeLinks()})`;
                const descricaoProgresso = document.getElementById("descricaoProgresso");
                descricaoProgresso.textContent = textoDescricao;
            }

            window.limparLocalStorage = function () {
                $('#confirmacaoModal').modal('show');
            };

            window.proximaPagina = proximaPagina;
            window.paginaAnterior = paginaAnterior;

            // Função para confirmar volta ao menu principal
            window.confirmarVoltarHome = function () {
                $('#voltarHomeModal').modal('show');
            };

            $(document).ready(function () {
                $('body').append(`
                            <div class="modal fade" id="confirmacaoModal" tabindex="-1" aria-labelledby="confirmacaoModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="confirmacaoModalLabel">Confirmação</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            Deseja realmente reiniciar todo o progresso? Ao confirmar será excluido todo o historico de acesso aos links de cada tópico que está armazenado no Local Storage, essa ação irá fazer você voltar ao tópico 1.
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                            <button type="button" class="btn btn-danger" onclick="localStorage.removeItem('simulado-az-104'); $('#confirmacaoModal').modal('hide'); location.reload();">Reiniciar o Progresso</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);

                // Modal de confirmação para voltar ao menu principal
                $('body').append(`
                            <div class="modal fade" id="voltarHomeModal" tabindex="-1" aria-labelledby="voltarHomeModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="voltarHomeModalLabel">Voltar ao Menu Principal</h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            Tem certeza que deseja voltar ao menu principal? Ao confirmar você será redirecionado para a página "Simulados para as Certificações da Microsoft Azure".
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                                            <button type="button" class="btn btn-primary" onclick="window.location.href='../../index.html';">Confirmar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);

                exibirTopicos();
            });

            exibirTopicos();
        }

        iniciar();
    </script>

    <footer>
        <div class="container">
            <div class="d-flex justify-content-between mt-3">
                <div>
                    <button id="btnLimpar" class="btn btn-danger" onclick="limparLocalStorage()">Reiniciar o
                        Progresso</button>
                </div>
                <div>
                    <button id="btnAnterior" class="btn btn-primary" onclick="paginaAnterior()">Anterior</button>
                    <!-- Botão Home adicionado aqui -->
                    <button id="btnHome" class="btn btn-primary" onclick="confirmarVoltarHome()">Menu</button>
                    <button id="btnProxima" class="btn btn-primary" onclick="proximaPagina()">Próxima</button>
                </div>
                <div>
                    <div id="infoPagina" class="text-right"></div>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>